-- ============================================================================
-- ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุธููุฑ ุงููุณุงุชูู ุงูุฌุฏูุฏุฉ ูู ุงููุชุฌุฑ
-- Fix for New Dresses Not Appearing in Store Frontend
-- ============================================================================
-- ุงูุชุงุฑูุฎ: 2025-11-08
-- ุงููุดููุฉ: ุงููุณุงุชูู ุงููุถุงูุฉ ูู ููุญุฉ ุงูุชุญูู ูุง ุชุธูุฑ ูู ุตูุญุฉ ุงููุชุฌุฑ
-- ุงูุณุจุจ: ุณูุงุณุฉ RLS ุชุชุทูุจ published_at IS NOT NULL
-- ============================================================================

-- ============================================================================
-- ุงูุฎุทูุฉ 1: ุงูุชุญูู ูู ุงูุณูุงุณุงุช ุงูุญุงููุฉ
-- ============================================================================

-- ุนุฑุถ ุฌููุน ุงูุณูุงุณุงุช ุนูู ุฌุฏูู products
SELECT 
  policyname, 
  cmd,
  qual as "ุดุฑุท ุงูุนุฑุถ (USING)",
  with_check as "ุดุฑุท ุงูุฅุฏุฎุงู (WITH CHECK)"
FROM pg_policies 
WHERE tablename = 'products'
ORDER BY policyname;

-- ============================================================================
-- ุงูุฎุทูุฉ 2: ุญุฐู ุงูุณูุงุณุฉ ุงููุฏููุฉ ูุฅูุดุงุก ุงูุณูุงุณุฉ ุงูุฌุฏูุฏุฉ
-- ============================================================================

-- ุญุฐู ุงูุณูุงุณุฉ ุงููุฏููุฉ ุงูุชู ุชุชุทูุจ published_at IS NOT NULL
DROP POLICY IF EXISTS "Anyone can view available products" ON public.products;

-- ุฅูุดุงุก ุงูุณูุงุณุฉ ุงูุฌุฏูุฏุฉ ุงููุญุณููุฉ
-- ุงูุณูุงุญ ุจุนุฑุถ ุงูููุชุฌุงุช ุญุชู ุจุฏูู ุชุงุฑูุฎ ูุดุฑ
CREATE POLICY "Anyone can view available products"
  ON public.products
  FOR SELECT
  USING (
    is_available = true
    AND (
      published_at IS NULL  -- โ ุงูุณูุงุญ ุจุงูููุชุฌุงุช ุจุฏูู ุชุงุฑูุฎ ูุดุฑ
      OR published_at <= NOW()  -- โ ุฃู ุงูููุชุฌุงุช ุงูููุดูุฑุฉ
    )
  );

-- ============================================================================
-- ุงูุฎุทูุฉ 3: ุชุญุฏูุซ ุงูููุชุฌุงุช ุงูููุฌูุฏุฉ ุงูุชู ููุง published_at = NULL
-- ============================================================================

-- ุชุญุฏูุซ ุฌููุน ุงูููุชุฌุงุช ุงููุชุงุญุฉ ุงูุชู ููุณ ููุง ุชุงุฑูุฎ ูุดุฑ
-- ุณูุชู ุชุนููู ุชุงุฑูุฎ ุงููุดุฑ = ุชุงุฑูุฎ ุงูุฅูุดุงุก
UPDATE public.products 
SET published_at = created_at 
WHERE published_at IS NULL 
  AND is_available = true;

-- ุนุฑุถ ุนุฏุฏ ุงูููุชุฌุงุช ุงูุชู ุชู ุชุญุฏูุซูุง
SELECT 
  COUNT(*) as "ุนุฏุฏ ุงูููุชุฌุงุช ุงููุญุฏุซุฉ",
  'ุชู ุชุญุฏูุซ ุชุงุฑูุฎ ุงููุดุฑ ุจูุฌุงุญ' as "ุงูุญุงูุฉ"
FROM public.products 
WHERE published_at IS NOT NULL 
  AND is_available = true;

-- ============================================================================
-- ุงูุฎุทูุฉ 4: (ุงุฎุชูุงุฑู) ุชุนููู ูููุฉ ุงูุชุฑุงุถูุฉ ูู published_at
-- ============================================================================

-- ุชุนููู ูููุฉ ุงูุชุฑุงุถูุฉ ูุญูู published_at = NOW()
-- ูุฐุง ุณูุฌุนู ุฌููุน ุงูููุชุฌุงุช ุงูุฌุฏูุฏุฉ ุชููุดุฑ ุชููุงุฆูุงู
-- โ๏ธ ุชุญุฐูุฑ: ูู ุจุชุทุจูู ูุฐุง ููุท ุฅุฐุง ููุช ุชุฑูุฏ ูุดุฑ ุฌููุน ุงูููุชุฌุงุช ุชููุงุฆูุงู
-- โ๏ธ ุฅุฐุง ููุช ุชุฑูุฏ ุงูุชุญูู ุงููุฏูู ูู ุงููุดุฑุ ูุง ุชูู ุจุชุทุจูู ูุฐุง ุงูุฃูุฑ

-- ALTER TABLE public.products 
-- ALTER COLUMN published_at SET DEFAULT NOW();

-- ============================================================================
-- ุงูุฎุทูุฉ 5: ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
-- ============================================================================

-- ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู (anon) ูุฏููู ุตูุงุญูุฉ SELECT
GRANT SELECT ON public.products TO anon;
GRANT SELECT ON public.categories TO anon;

-- ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏููู ุงููุณุฌููู (authenticated) ูุฏููู ุงูุตูุงุญูุงุช ุงููุงููุฉ
GRANT ALL ON public.products TO authenticated;
GRANT ALL ON public.categories TO authenticated;

-- ============================================================================
-- ุงูุฎุทูุฉ 6: ุงุฎุชุจุงุฑ ุงูุณูุงุณุฉ
-- ============================================================================

-- ุนุฑุถ ุฌููุน ุงูููุชุฌุงุช ุงููุชุงุญุฉ (ููุง ูุฑุงูุง ุงููุณุชุฎุฏู ุบูุฑ ุงููุณุฌู)
SELECT 
  id,
  title,
  is_available,
  published_at,
  created_at,
  CASE 
    WHEN published_at IS NULL THEN 'โ ุณูุธูุฑ (ุจุฏูู ุชุงุฑูุฎ ูุดุฑ)'
    WHEN published_at <= NOW() THEN 'โ ุณูุธูุฑ (ููุดูุฑ)'
    ELSE 'โ ูู ูุธูุฑ (ููุนุฏ ูุดุฑ ูุณุชูุจูู)'
  END as "ุญุงูุฉ ุงูุธููุฑ"
FROM public.products 
WHERE is_available = true
ORDER BY created_at DESC
LIMIT 10;

-- ============================================================================
-- ุงูุฎุทูุฉ 7: ุนุฑุถ ุฅุญุตุงุฆูุงุช ุงูููุชุฌุงุช
-- ============================================================================

SELECT 
  COUNT(*) FILTER (WHERE is_available = true) as "ููุชุฌุงุช ูุชุงุญุฉ",
  COUNT(*) FILTER (WHERE is_available = true AND published_at IS NOT NULL) as "ููุชุฌุงุช ูุชุงุญุฉ ูููุดูุฑุฉ",
  COUNT(*) FILTER (WHERE is_available = true AND published_at IS NULL) as "ููุชุฌุงุช ูุชุงุญุฉ ุจุฏูู ุชุงุฑูุฎ ูุดุฑ",
  COUNT(*) FILTER (WHERE is_available = false) as "ููุชุฌุงุช ุบูุฑ ูุชุงุญุฉ",
  COUNT(*) as "ุฅุฌูุงูู ุงูููุชุฌุงุช"
FROM public.products;

-- ============================================================================
-- ููุงุญุธุงุช ูููุฉ
-- ============================================================================

-- 1. ุงูุณูุงุณุฉ ุงูุฌุฏูุฏุฉ ุชุณูุญ ุจุนุฑุถ ุงูููุชุฌุงุช ุฅุฐุง:
--    โ is_available = true
--    โ published_at IS NULL ุฃู published_at <= NOW()

-- 2. ููุชุญูู ูู ุฃู ุงูุณูุงุณุฉ ุชุนูู:
--    โ ุงูุชุญ ุงููููุน ูู ูุถุน Incognito (ุจุฏูู ุชุณุฌูู ุฏุฎูู)
--    โ ุงูุชูู ุฅูู http://localhost:3001/designs
--    โ ูุฌุจ ุฃู ุชุธูุฑ ุฌููุน ุงูููุชุฌุงุช ุงููุชุงุญุฉ

-- 3. ุชู ุชุนุฏูู ููุฏ ููุญุฉ ุงูุชุญูู ูุฅุถุงูุฉ published_at ุชููุงุฆูุงู ุนูุฏ ุฅูุดุงุก ููุชุฌ ุฌุฏูุฏ
--    โ src/app/dashboard/ready-designs/page.tsx (ุงูุณุทุฑ 233)

-- 4. ุชู ุฅุถุงูุฉ ุชุญุฏูุซ ุชููุงุฆู ูููุชุฌุฑ ุงูุฃูุงูู ุจุนุฏ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ
--    โ src/app/dashboard/ready-designs/page.tsx (ุงูุณุทูุฑ 256-264)

-- ============================================================================
-- ููุงูุฉ ุงูุณูุฑูุจุช
-- ============================================================================

-- โ ุจุนุฏ ุชุทุจูู ูุฐุง ุงูุณูุฑูุจุช:
-- 1. ุฌููุน ุงูููุชุฌุงุช ุงููุชุงุญุฉ ุณุชุธูุฑ ูู ุงููุชุฌุฑ (ุญุชู ุจุฏูู ุชุงุฑูุฎ ูุดุฑ)
-- 2. ุงูููุชุฌุงุช ุงูุฌุฏูุฏุฉ ุณุชููุดุฑ ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุชูุง ูู ููุญุฉ ุงูุชุญูู
-- 3. ุงููุชุฌุฑ ุงูุฃูุงูู ุณูุชุญุฏุซ ุชููุงุฆูุงู ุจุนุฏ ุฅุถุงูุฉ ููุชุฌ ุฌุฏูุฏ

-- ๐ก ููุชุญูู ูู ูุฌุงุญ ุงูุชุทุจูู:
-- SELECT policyname, qual FROM pg_policies WHERE tablename = 'products' AND policyname = 'Anyone can view available products';

