# تفعيل ميزة إلغاء قفل الشهر في نظام رواتب العمال

## المشكلة
كانت هناك مشكلة في قسم رواتب العمال (التفصيل) حيث أنه إذا تم قفل الشهر عن طريق الخطأ، لا يمكن إعادة فتحه مرة أخرى.

## الحل
تم إضافة ميزة **إلغاء قفل الشهر** التي تسمح للأدمن بإعادة فتح الشهر المقفل والسماح بالتعديلات مرة أخرى.

## خطوات التفعيل

### 1. تطبيق قاعدة البيانات (Migration)

يجب تطبيق ملف SQL الجديد على قاعدة بيانات Supabase. اختر إحدى الطريقتين:

#### الطريقة الأولى: عبر لوحة تحكم Supabase (الأسهل)

1. افتح لوحة تحكم Supabase الخاصة بمشروعك
2. اذهب إلى **SQL Editor**
3. انقر على **New query**
4. انسخ محتوى الملف التالي بالكامل:
   - `migrations/21-unlock-payroll-period.sql`
   أو
   - `supabase/migrations/18-unlock-payroll-period.sql`
5. الصق المحتوى في محرر SQL
6. انقر على **Run** أو **Execute**
7. تأكد من ظهور رسالة نجاح (Success)

#### الطريقة الثانية: عبر Supabase CLI (للمطورين)

```bash
# إذا كان لديك Supabase CLI مثبتة
supabase db push

# أو تطبيق migration محددة
supabase migration up
```

### 2. التأكد من التفعيل

بعد تطبيق migration، يمكنك التأكد من نجاح العملية:

1. افتح صفحة **رواتب العمال - قسم التفصيل**
2. اختر أي شهر محاسبي
3. اضغط على **قفل الشهر**
4. يجب أن يظهر زر أخضر جديد باسم **إلغاء قفل الشهر**
5. اضغط على **إلغاء قفل الشهر**
6. أكد العملية
7. يجب أن يتم إلغاء القفل بنجاح وتظهر رسالة "تم إلغاء قفل الشهر بنجاح"

## الميزات الجديدة

### واجهة المستخدم
- **زر قفل الشهر** (أحمر): يظهر عندما يكون الشهر مفتوحاً
- **زر إلغاء قفل الشهر** (أخضر): يظهر عندما يكون الشهر مقفلاً
- تأكيد قبل إلغاء القفل لتجنب الأخطاء
- رسالة نجاح عند إتمام العملية

### الصلاحيات
- **إلغاء القفل متاح للأدمن فقط**
- يتطلب تأكيد قبل التنفيذ
- يتم تسجيل المستخدم الذي قام بإلغاء القفل

### التأثير على النظام
عند إلغاء قفل الشهر:
1. يتم تحديث جدول `worker_payroll_period_locks` وتعيين `is_locked = FALSE`
2. يتم تحديث جميع سجلات العمال في `worker_payroll_months` لذلك الشهر
3. يصبح بإمكان الأدمن إضافة/تعديل الرواتب والدفعات والخصومات مرة أخرى

## ملفات تم تعديلها

1. **قاعدة البيانات**:
   - `migrations/21-unlock-payroll-period.sql` - إجراء SQL جديد
   - `supabase/migrations/18-unlock-payroll-period.sql` - نسخة Supabase

2. **الخدمات (Services)**:
   - `src/lib/services/worker-payroll-service.ts` - إضافة دالة `unlockWorkerPayrollPeriod`

3. **الواجهة (UI)**:
   - `src/components/TailoringPayrollDashboard.tsx` - إضافة زر إلغاء القفل ومعالج الحدث

## الدعم الفني

إذا واجهت أي مشاكل أثناء التطبيق:
1. تأكد من تطبيق migration بشكل صحيح
2. تحقق من صلاحيات المستخدم (يجب أن يكون Admin)
3. راجع console المتصفح للتحقق من أي أخطاء
4. تحقق من Supabase logs للتأكد من نجاح العمليات

---
**تاريخ الإضافة**: 21 فبراير 2026
**الحالة**: جاهز للتطبيق ✅
