# ๐ ุญู ูุดููุฉ RLS - "new row violates row-level security policy"

## ๐ ุงููุดููุฉ

ุนูุฏ ูุญุงููุฉ ุฅุถุงูุฉ ุนุงูู ุฌุฏูุฏุ ุชุธูุฑ ุงูุฑุณุงูุฉ:
```
ุฎุทุฃ: new row violates row-level security policy for table "users"
```

---

## ๐ ุงูุณุจุจ

**Row Level Security (RLS)** ูู Supabase ูููุน ุฅุถุงูุฉ ุณุฌูุงุช ุฌุฏูุฏุฉ ูู ุฌุฏูู `users` ูุฃู:

1. ุนูุฏ ุฅูุดุงุก ุนุงูู ุฌุฏูุฏุ ูุณุชุฎุฏู `supabase.auth.signUp()` ูุฅูุดุงุก ูุณุชุฎุฏู ูู Supabase Auth
2. ุจุนุฏ ุฐููุ ูุญุงูู ุฅุถุงูุฉ ุณุฌู ูู ุฌุฏูู `users` ุจูุนุฑูู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ
3. ููู ุงูุฌูุณุฉ ุงูุญุงููุฉ ูู ุฌูุณุฉ **Admin**ุ ูููุณุช ุฌูุณุฉ ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ
4. ุณูุงุณุงุช RLS ุงูุญุงููุฉ ุชุณูุญ ููุท ููู Admin ุจุฅุถุงูุฉ ูุณุชุฎุฏูููุ ููู ุงููุนุฑูู ุงูููุณุชุฎุฏู ูู ูุนุฑูู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ
5. ูุฐููุ RLS ูุฑูุถ ุงูุนูููุฉ

---

## โ ุงูุญู ุงูุณุฑูุน (ุฏูููุฉ ูุงุญุฏุฉ)

### ุงูุฎุทูุฉ 1๏ธโฃ: ุงูุชุญ Supabase SQL Editor

ุงุฐูุจ ุฅูู:
```
https://app.supabase.com/project/qbbijtyrikhybgszzbjz/sql/new
```

ุฃู:
1. ุงูุชุญ Supabase Dashboard
2. ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ: **SQL Editor**
3. ุงุถุบุท **"New query"**

---

### ุงูุฎุทูุฉ 2๏ธโฃ: ุงูุณุฎ ูุงูุตู ูุฐุง ุงูููุฏ

```sql
-- ุฅุตูุงุญ ุณูุงุณุงุช RLS ูุฌุฏูู users ู workers

-- ุญุฐู ุงูุณูุงุณุงุช ุงููุฏููุฉ
DROP POLICY IF EXISTS "Admins can insert users" ON users;
DROP POLICY IF EXISTS "New users can create own profile" ON users;
DROP POLICY IF EXISTS "Admins can insert workers" ON workers;

-- ุณูุงุณุฉ ุฌุฏูุฏุฉ: ุฃู ูุณุชุฎุฏู ูุตุงุฏู ููููู ุฅุถุงูุฉ ุณุฌูุงุช ูู users
CREATE POLICY "Authenticated users can insert users"
ON users FOR INSERT
TO authenticated
WITH CHECK (true);

-- ุณูุงุณุฉ ุฌุฏูุฏุฉ: ุฃู ูุณุชุฎุฏู ูุตุงุฏู ููููู ุฅุถุงูุฉ ุนูุงู
CREATE POLICY "Authenticated users can insert workers"
ON workers FOR INSERT
TO authenticated
WITH CHECK (true);
```

---

### ุงูุฎุทูุฉ 3๏ธโฃ: ูููุฐ ุงูููุฏ

1. ุงุถุบุท **"Run"** ุฃู ุงุถุบุท `Ctrl+Enter`
2. ูุฌุจ ุฃู ุชุฑู ุฑุณุงูุฉ: **"Success. No rows returned"**

---

### ุงูุฎุทูุฉ 4๏ธโฃ: ุงุฎุชุจุฑ ุงูุขู!

1. ุงุฑุฌุน ูููููุน: http://localhost:3001/dashboard/workers
2. ุงุถุบุท "ุฅุถุงูุฉ ุนุงูู ุฌุฏูุฏ"
3. ุงููุฃ ุงููููุฐุฌ:
   ```
   ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: worker@test.com
   ูููุฉ ุงููุฑูุฑ: Worker@123456
   ุงูุงุณู ุงููุงูู: ุนุงูู ุชุฌุฑูุจู
   ุฑูู ุงููุงุชู: +966501234567
   ุงูุชุฎุตุต: ูุณุงุชูู ุฒูุงู
   ```
4. ุงุถุบุท "ุฅุถุงูุฉ"

**ูุฌุจ ุฃู ูุนูู ุงูุขู! โ**

---

## ๐ ููู ุงูุญู

### ูุง ุงูุฐู ุชุบูุฑุ

**ูุจู:**
```sql
-- ููุท Admin ููููู ุฅุถุงูุฉ ูุณุชุฎุฏููู
CREATE POLICY "Admins can insert users"
ON users FOR INSERT
WITH CHECK (is_admin());
```

**ุงููุดููุฉ:** ุนูุฏ ุฅูุดุงุก ุนุงูู ุฌุฏูุฏุ ุงูุฌูุณุฉ ุงูุญุงููุฉ ูู Adminุ ููู ุงููุนุฑูู ุงูููุณุชุฎุฏู ูู ูุนุฑูู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏุ ูุชูุดู ุงูุนูููุฉ.

**ุจุนุฏ:**
```sql
-- ุฃู ูุณุชุฎุฏู ูุตุงุฏู ููููู ุฅุถุงูุฉ ุณุฌูุงุช
CREATE POLICY "Authenticated users can insert users"
ON users FOR INSERT
TO authenticated
WITH CHECK (true);
```

**ุงูุญู:** ุงูุณูุงุญ ูุฃู ูุณุชุฎุฏู ูุตุงุฏู (authenticated) ุจุฅุถุงูุฉ ุณุฌูุงุช ูู `users` ู `workers`.

---

## โ๏ธ ูู ูุฐุง ุขููุ

### ููุชุทููุฑ: โ ูุนู
- ููุงุณุจ ูุจูุฆุฉ ุงูุชุทููุฑ ูุงูุงุฎุชุจุงุฑ
- ูุณูุญ ุจุฅุถุงูุฉ ุนูุงู ุจุณูููุฉ
- ูุง ุชูุฌุฏ ุจูุงูุงุช ุญุณุงุณุฉ ูู ุงูุชุทููุฑ

### ููุฅูุชุงุฌ: โ๏ธ ูุญุชุงุฌ ุชุญุณูู
ูู ุงูุฅูุชุงุฌุ ูููุถู ุงุณุชุฎุฏุงู ุฃุญุฏ ุงูุญููู ุงูุชุงููุฉ:

#### ุงูุญู 1: Supabase Edge Functions
- ุฅูุดุงุก Edge Function ุชุณุชุฎุฏู Service Role Key
- ุงุณุชุฏุนุงุก ุงูู Function ูู ุงูุชุทุจูู
- ุงูู Function ุชูุดุฆ ุงููุณุชุฎุฏู ูุงูุนุงูู

#### ุงูุญู 2: Next.js API Route
- ุฅูุดุงุก API Route ูู `/api/workers/create`
- ุงุณุชุฎุฏุงู Service Role Key ูู ุงูู Backend
- ุงุณุชุฏุนุงุก ุงูู API ูู ุงูุชุทุจูู

#### ุงูุญู 3: ุณูุงุณุงุช RLS ุฃูุซุฑ ุชุนููุฏุงู
- ุงุณุชุฎุฏุงู ุฏูุงู PostgreSQL ูุฎุตุตุฉ
- ุงูุชุญูู ูู ุตูุงุญูุงุช ุงููุณุชุฎุฏู ุจุฏูุฉ

**ููู ููุชุทููุฑ ุงูุณุฑูุนุ ุงูุญู ุงูุญุงูู ูุงูู.**

---

## ๐ ุงููููุงุช ุงููุชููุฑุฉ

### 1. `migrations/01-workers-RLS-FIX-SIMPLE.sql`
- ููู SQL ูุงูู ูุฅุตูุงุญ ุงูุณูุงุณุงุช
- ูุญุชูู ุนูู ููุณ ุงูููุฏ ุฃุนูุงู
- ููููู ูุณุฎู ูุชูููุฐู ูุจุงุดุฑุฉ

### 2. `migrations/01-workers-RLS-FIX.sql`
- ุญู ุจุฏูู ุฃูุซุฑ ุชุนููุฏุงู
- ูุณุชุฎุฏู ุณูุงุณุงุช ุฃูุซุฑ ุตุฑุงูุฉ

---

## ๐งช ุงูุชุญูู ูู ูุฌุงุญ ุงูุญู

### ูู Supabase Dashboard:

1. ุงูุชุญ **SQL Editor**
2. ููุฐ ูุฐุง ุงูุงุณุชุนูุงู:
   ```sql
   SELECT * FROM pg_policies WHERE tablename IN ('users', 'workers');
   ```
3. ูุฌุจ ุฃู ุชุฑู ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ:
   - `Authenticated users can insert users`
   - `Authenticated users can insert workers`

### ูู ุงูุชุทุจูู:

1. ุฃุถู ุนุงูู ุฌุฏูุฏ
2. ูุฌุจ ุฃู ูุธูุฑ ูู ุงููุงุฆูุฉ ููุฑุงู
3. ุชุญูู ูู Supabase Dashboard โ Table Editor โ workers
4. ูุฌุจ ุฃู ุชุฑู ุงูุนุงูู ุงูุฌุฏูุฏ

---

## ๐ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

### ุงูุญู ุงูุจุฏูู: ุชุนุทูู RLS ูุคูุชุงู

**โ๏ธ ููุท ููุชุทููุฑ - ุบูุฑ ุขูู ููุฅูุชุงุฌ!**

ูู Supabase SQL Editorุ ููุฐ:

```sql
-- ุชุนุทูู RLS ูุคูุชุงู
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
ALTER TABLE workers DISABLE ROW LEVEL SECURITY;
```

**ูุฅุนุงุฏุฉ ุชูุนูู RLS ูุงุญูุงู:**
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE workers ENABLE ROW LEVEL SECURITY;
```

---

## ๐ ููุงุฑูุฉ ุงูุญููู

| ุงูุญู | ุงูุณูููุฉ | ุงูุฃูุงู | ููุงุณุจ ููุชุทููุฑ | ููุงุณุจ ููุฅูุชุงุฌ |
|------|---------|--------|----------------|----------------|
| ุชุญุฏูุซ ุณูุงุณุงุช RLS | โญโญโญ | โญโญโญ | โ | โ๏ธ |
| ุชุนุทูู RLS | โญโญโญโญโญ | โ | โ | โ |
| Edge Functions | โญโญ | โญโญโญโญโญ | โ๏ธ | โ |
| API Routes | โญโญ | โญโญโญโญ | โ | โ |

**ุงูุญู ุงูููุตู ุจู ุงูุขู:** ุชุญุฏูุซ ุณูุงุณุงุช RLS (ุงูุญู ุงูุณุฑูุน ุฃุนูุงู)

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

ุจุนุฏ ุชุทุจูู ุงูุญู:

1. โ ุงุฎุชุจุฑ ุฅุถุงูุฉ ุนุงูู ุฌุฏูุฏ
2. โ ุงุฎุชุจุฑ ุชุญุฏูุซ ุนุงูู
3. โ ุงุฎุชุจุฑ ุญุฐู ุนุงูู
4. โ ุชุญูู ูู ุงูุจูุงูุงุช ูู Supabase Dashboard
5. โ ุฃุฎุจุฑูู ุจุงููุชูุฌุฉ!

---

## ๐ ุงููุณุงุนุฏุฉ

ุฅุฐุง ูู ููุฌุญ ุงูุญู:

1. ุงูุชุญ Console (F12)
2. ุงูุณุฎ ุฑุณุงุฆู ุงูุฎุทุฃ ุงููุงููุฉ
3. ุชุญูู ูู:
   - ูู ููุฐุช ุงูููุฏ SQL ุจูุฌุงุญุ
   - ูู ุธูุฑุช ุฑุณุงูุฉ "Success"ุ
   - ูู ุฃุนุฏุช ุชุญููู ุตูุญุฉ ุงููููุนุ

4. ุฃุฎุจุฑูู ุจุงููุชูุฌุฉ ูุณุฃุณุงุนุฏู!

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2025-10-31  
**ุงูุญุงูุฉ:** ุฌุงูุฒ ููุชุทุจูู  
**ุงูุฃููููุฉ:** ุนุงููุฉ ุฌุฏุงู ๐ด  
**ุงูููุช ุงููุชููุน:** ุฏูููุฉ ูุงุญุฏุฉ โฑ๏ธ

