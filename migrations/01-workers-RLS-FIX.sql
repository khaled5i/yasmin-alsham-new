-- ============================================================================
-- إصلاح سياسات RLS لجدول Users
-- المشكلة: لا يمكن إنشاء مستخدمين جدد من التطبيق
-- الحل: السماح للمستخدمين الجدد بإنشاء سجلاتهم الخاصة بعد التسجيل
-- ============================================================================

-- حذف السياسة القديمة
DROP POLICY IF EXISTS "Admins can insert users" ON users;

-- سياسة جديدة: Admin يمكنه إنشاء مستخدمين جدد
CREATE POLICY "Admins can insert users"
ON users FOR INSERT
WITH CHECK (is_admin());

-- سياسة جديدة: المستخدمون الجدد يمكنهم إنشاء سجلاتهم الخاصة بعد التسجيل
-- هذا يسمح للمستخدم الذي سجل للتو في Supabase Auth بإنشاء سجله في جدول users
DROP POLICY IF EXISTS "New users can create own profile" ON users;
CREATE POLICY "New users can create own profile"
ON users FOR INSERT
WITH CHECK (auth.uid() = id);

-- ============================================================================
-- ملاحظات:
-- ============================================================================
-- 1. الآن يمكن للـ Admin إنشاء مستخدمين جدد
-- 2. يمكن للمستخدم الجديد (بعد التسجيل في Auth) إنشاء سجله في جدول users
-- 3. هذا يحل مشكلة "new row violates row-level security policy"
-- ============================================================================

