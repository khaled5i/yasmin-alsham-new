-- ============================================================================
-- Yasmin Al-Sham - Simple Order Number Migration
-- تحديث دالة توليد رقم الطلب لاستخدام ترقيم تسلسلي بسيط
-- ============================================================================

-- ============================================================================
-- 1. تحديث دالة توليد رقم الطلب
-- ============================================================================

-- حذف الدالة القديمة وإنشاء دالة جديدة بترقيم بسيط
CREATE OR REPLACE FUNCTION generate_order_number()
RETURNS TEXT AS $$
DECLARE
  new_number INTEGER;
BEGIN
  -- الحصول على أكبر رقم طلب حالي وإضافة 1
  SELECT COALESCE(
    MAX(
      CASE 
        WHEN order_number ~ '^\d+$' THEN order_number::INTEGER
        ELSE 0
      END
    ), 0
  ) + 1 INTO new_number
  FROM orders;
  
  -- إرجاع الرقم كنص
  RETURN new_number::TEXT;
END;
$$ LANGUAGE plpgsql;

-- ============================================================================
-- 2. التعليقات التوضيحية
-- ============================================================================

COMMENT ON FUNCTION generate_order_number() IS 'توليد رقم طلب تسلسلي بسيط (1, 2, 3, ...)';

-- ملاحظة: الـ trigger الموجود (trigger_set_order_number) سيستمر في العمل
-- ولا حاجة لتعديله لأنه يستدعي نفس الدالة generate_order_number()

