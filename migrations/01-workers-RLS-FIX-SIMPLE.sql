-- ============================================================================
-- إصلاح سياسات RLS - الحل البسيط للتطوير
-- المشكلة: عند إنشاء عامل جديد، Admin لا يستطيع إضافة سجل في جدول users
-- الحل: السماح لأي مستخدم مصادق (authenticated) بإضافة سجلات في users
-- ============================================================================

-- ============================================================================
-- الخيار 1: السماح لأي مستخدم مصادق بإضافة سجلات (موصى به للتطوير)
-- ============================================================================

-- حذف السياسة القديمة
DROP POLICY IF EXISTS "Admins can insert users" ON users;
DROP POLICY IF EXISTS "New users can create own profile" ON users;

-- سياسة جديدة: أي مستخدم مصادق يمكنه إضافة سجلات في users
CREATE POLICY "Authenticated users can insert users"
ON users FOR INSERT
TO authenticated
WITH CHECK (true);

-- ============================================================================
-- الخيار 2: تعطيل RLS مؤقتاً (للتطوير فقط - غير آمن!)
-- ============================================================================
-- إذا لم ينجح الخيار 1، استخدم هذا:
-- ALTER TABLE users DISABLE ROW LEVEL SECURITY;
-- ALTER TABLE workers DISABLE ROW LEVEL SECURITY;

-- ملاحظة: لا تنسى إعادة تفعيل RLS في الإنتاج:
-- ALTER TABLE users ENABLE ROW LEVEL SECURITY;
-- ALTER TABLE workers ENABLE ROW LEVEL SECURITY;

-- ============================================================================
-- تحديث سياسات workers أيضاً
-- ============================================================================

DROP POLICY IF EXISTS "Admins can insert workers" ON workers;

-- السماح لأي مستخدم مصادق بإضافة عمال
CREATE POLICY "Authenticated users can insert workers"
ON workers FOR INSERT
TO authenticated
WITH CHECK (true);

-- ============================================================================
-- ملاحظات مهمة:
-- ============================================================================
-- 1. هذا الحل مناسب لبيئة التطوير فقط
-- 2. في الإنتاج، يجب استخدام سياسات أكثر صرامة
-- 3. البديل الأفضل هو استخدام Supabase Edge Functions أو API Routes
-- 4. لكن للتطوير السريع، هذا الحل يعمل بشكل جيد
-- ============================================================================

-- ============================================================================
-- اختبار السياسات
-- ============================================================================
-- بعد تنفيذ هذا الملف، جرب إضافة عامل جديد من التطبيق
-- يجب أن يعمل بدون مشاكل
-- ============================================================================

