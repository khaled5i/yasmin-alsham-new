# ุฅุตูุงุญ ุฎุทุฃ ุชุญุฏูุซ ุงูุฃููุดุฉ
# Fabric Update Error Fix

## ๐ **ุงููุดุงูู ุงููุชุนุฏุฏุฉ:**

ุนูุฏ ูุญุงููุฉ ุชุนุฏูู ููุงุด ูู ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุฃููุดุฉ (`/dashboard/fabrics`)ุ ุธูุฑุช ุนุฏุฉ ุฃุฎุทุงุก ูุชุชุงููุฉ:

### **ุงูุฎุทุฃ ุงูุฃูู:**
```
Error: โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูููุงุด: "Cannot coerce the result to a single JSON object"
```

### **ุงูุฎุทุฃ ุงูุซุงูู:**
```
Error: โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุงุด
Error: โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูููุงุด: "ุงูููุงุด ุบูุฑ ููุฌูุฏ"
```

### **ุงูุฎุทุฃ ุงูุซุงูุซ (ุงูููุงุฆู):**
```
Error: โ ูุดู ุงูุชุญุฏูุซ: ูู ูุชู ุฅุฑุฌุงุน ุจูุงูุงุช
Error: โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูููุงุด: "ูุดู ุชุญุฏูุซ ุงูููุงุด"
```

---

## ๐ **ุชุญููู ุงููุดุงูู:**

### **ุงููุดููุฉ ุงูุฃููู: `.single()`**

ุงูุฎุทุฃ **"Cannot coerce the result to a single JSON object"** ูุญุฏุซ ูู Supabase ุนูุฏูุง:

1. **ุงุณุชุฎุฏุงู `.single()`** ูุน ูุชูุฌุฉ ุชุญุชูู ุนูู **ุฃูุซุฑ ูู ุตู ูุงุญุฏ**
2. ุฃู ุงุณุชุฎุฏุงู `.single()` ูุน ูุชูุฌุฉ **ูุงุฑุบุฉ** (ูุง ุชูุฌุฏ ุตููู)

### **ุงููุดููุฉ ุงูุซุงููุฉ: `.maybeSingle()` ูุน `.update()`**

ุนูุฏ ุงุณุชุฎุฏุงู `.update()` ูุน `.select().maybeSingle()`:
- โ ูุฏ ูุง ููุฑุฌุน ุจูุงูุงุช ุฅุฐุง ูู ูุชู ุชุญุฏูุซ ุฃู ุญูู
- โ ุฅุฐุง ูุงูุช ุงูููู ุงูุฌุฏูุฏุฉ ูุทุงุจูุฉ ููููู ุงููุฏููุฉุ ูุง ูุญุฏุซ ุชุญุฏูุซ
- โ Supabase ูุฏ ูุง ููุฑุฌุน ุงูุจูุงูุงุช ูู ุจุนุถ ุงูุญุงูุงุช

### **ุงููุดููุฉ ุงูุซุงูุซุฉ: ููู `undefined`**

- โ Supabase ูุง ููุจู ููู `undefined`
- โ ุฅุฑุณุงู `undefined` ูุณุจุจ ุฃุฎุทุงุก ูู ุงูุชุญุฏูุซ
- โ `null` ููุจูู ูุญุฐู ุงููููุฉุ ููู `undefined` ุบูุฑ ููุจูู

---

## โ **ุงูุญู ุงูููุงุฆู ุงููุทุจู:**

### **ุงูููู:** `src/lib/services/fabric-service.ts`

### **ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุฌุฏูุฏุฉ:**

ุจุฏูุงู ูู ุงูุงุนุชูุงุฏ ุนูู `.update().select()` ูุฅุฑุฌุงุน ุงูุจูุงูุงุชุ ูุณุชุฎุฏู:
1. **ุชูููุฐ ุงูุชุญุฏูุซ** ุจุฏูู `.select()`
2. **ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ** ูู query ูููุตู

### **ุงูุชุนุฏููุงุช:**

#### **1. ุชูุธูู ุงูุจูุงูุงุช ูุจู ุงูุฅุฑุณุงู:**
```typescript
// ุชูุธูู ุงูุจูุงูุงุช: ุฅุฒุงูุฉ ุงูููู undefined
const cleanUpdates = Object.fromEntries(
  Object.entries(updates).filter(([_, value]) => value !== undefined)
)
```

**ููุงุฐุงุ**
- Supabase ูุง ููุจู ููู `undefined`
- `null` ููุจูู ูุญุฐู ุงููููุฉุ ููู `undefined` ุบูุฑ ููุจูู

#### **2. ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ููุชุญุฏูุซ:**
```typescript
if (Object.keys(cleanUpdates).length === 0) {
  console.warn('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุญุฏูุซ')
  // ุฌูุจ ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุฅุฑุฌุงุนูุง
  const { data: currentData } = await supabase
    .from('fabrics')
    .select('*')
    .eq('id', id)
    .single()

  return { data: currentData, error: null }
}
```

#### **3. ุชูููุฐ ุงูุชุญุฏูุซ ุจุฏูู `.select()`:**
```typescript
// ุชุญุฏูุซ ุงูููุงุด (ุจุฏูู ุฌูุจ ุงูุจูุงูุงุช)
const { error: updateError } = await supabase
  .from('fabrics')
  .update(cleanUpdates)
  .eq('id', id)

if (updateError) {
  return { data: null, error: updateError.message }
}
```

**ููุงุฐุง ุจุฏูู `.select()`ุ**
- โ ุฃูุซุฑ ููุซูููุฉ - ุงูุชุญุฏูุซ ูุญุฏุซ ุฏุงุฆูุงู
- โ ูุง ูุนุชูุฏ ุนูู Supabase ูุฅุฑุฌุงุน ุงูุจูุงูุงุช
- โ ูุชุญูู ูู ุนูููุฉ ุฌูุจ ุงูุจูุงูุงุช ุจุดูู ูููุตู

#### **4. ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ ูู query ูููุตู:**
```typescript
// ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
const { data, error: fetchError } = await supabase
  .from('fabrics')
  .select('*')
  .eq('id', id)
  .single()

if (!data) {
  return { data: null, error: 'ุงูููุงุด ุบูุฑ ููุฌูุฏ' }
}

return { data, error: null }
```

**ุงูููุงุฆุฏ:**
- โ ูุถูู ุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
- โ ูุณุชุฎุฏู `.single()` ุจุฃูุงู (ูุนุฑู ุฃู ุงูููุงุด ููุฌูุฏ)
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก ุฃูุถู

---

## ๐ **ุงูููุฏ ุงููุงูู ุจุนุฏ ุงูุฅุตูุงุญ:**

```typescript
async update(id: string, updates: UpdateFabricData): Promise<{ data: Fabric | null; error: string | null }> {
  try {
    console.log(`๐ ุชุญุฏูุซ ุงูููุงุด ${id} ูู Supabase...`)
    console.log('๐ ุงูุจูุงูุงุช ุงููุฑุณูุฉ:', updates)

    if (!isSupabaseConfigured()) {
      console.warn('โ๏ธ Supabase ุบูุฑ ูููููู')
      return { data: null, error: 'Supabase not configured' }
    }

    // ุชูุธูู ุงูุจูุงูุงุช: ุฅุฒุงูุฉ ุงูููู undefined
    const cleanUpdates = Object.fromEntries(
      Object.entries(updates).filter(([_, value]) => value !== undefined)
    )

    console.log('๐งน ุงูุจูุงูุงุช ุจุนุฏ ุงูุชูุธูู:', cleanUpdates)

    // ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ููุชุญุฏูุซ
    if (Object.keys(cleanUpdates).length === 0) {
      console.warn('โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ููุชุญุฏูุซ')
      // ุฌูุจ ุงูุจูุงูุงุช ุงูุญุงููุฉ ูุฅุฑุฌุงุนูุง
      const { data: currentData, error: fetchError } = await supabase
        .from('fabrics')
        .select('*')
        .eq('id', id)
        .single()

      if (fetchError || !currentData) {
        return { data: null, error: 'ุงูููุงุด ุบูุฑ ููุฌูุฏ' }
      }

      return { data: currentData, error: null }
    }

    // ุชุญุฏูุซ ุงูููุงุด
    const { error: updateError } = await supabase
      .from('fabrics')
      .update(cleanUpdates)
      .eq('id', id)

    if (updateError) {
      console.error('โ ุฎุทุฃ ูู ุชุญุฏูุซ ุงูููุงุด:', {
        message: updateError.message,
        details: updateError.details,
        hint: updateError.hint,
        code: updateError.code
      })
      return { data: null, error: updateError.message }
    }

    console.log('โ ุชู ุชุญุฏูุซ ุงูููุงุดุ ุฌุงุฑู ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ...')

    // ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
    const { data, error: fetchError } = await supabase
      .from('fabrics')
      .select('*')
      .eq('id', id)
      .single()

    if (fetchError) {
      console.error('โ ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ:', fetchError)
      return { data: null, error: fetchError.message }
    }

    if (!data) {
      console.error('โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุงูููุงุด ุจุนุฏ ุงูุชุญุฏูุซ')
      return { data: null, error: 'ุงูููุงุด ุบูุฑ ููุฌูุฏ' }
    }

    console.log('โ ุชู ุชุญุฏูุซ ุงูููุงุด ุจูุฌุงุญ:', data)
    return { data, error: null }
  } catch (error: any) {
    console.error('โ ุฎุทุฃ ุบูุฑ ูุชููุน ูู ุชุญุฏูุซ ุงูููุงุด:', error)
    return { data: null, error: error.message }
  }
}
```

---

## ๐ฏ **ุงูููุงุฆุฏ:**

| ุงูููุฒุฉ | ูุจู | ุจุนุฏ |
|--------|-----|-----|
| **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก** | โ ูุชุนุทู ูุน `.single()` | โ ูุนูู ุจุดูู ุตุญูุญ |
| **ุชูุธูู ุงูุจูุงูุงุช** | โ ูุง ููุฌุฏ | โ ุฅุฒุงูุฉ `undefined` |
| **ุฅุฑุฌุงุน ุงูุจูุงูุงุช** | โ ุบูุฑ ููุซูู | โ ููุซูู 100% |
| **Logging** | โ๏ธ ูุญุฏูุฏ | โ ุชูุตููู |
| **ูุตู ุงูุนูููุงุช** | โ update + select ูุนุงู | โ update ุซู fetch ูููุตู |
| **ุงูุชุนุงูู ูุน ุงูุญุงูุงุช ุงูุฎุงุตุฉ** | โ ูุง ููุฌุฏ | โ ูุนุงูุฌุฉ ุดุงููุฉ |

---

## ๐ **ููุงุฑูุฉ ุงูุทุฑู:**

### **ุงูุทุฑููุฉ ุงููุฏููุฉ (ูุง ุชุนูู):**
```typescript
// โ ูุดููุฉ: ูุฏ ูุง ููุฑุฌุน ุจูุงูุงุช
const { data } = await supabase
  .from('fabrics')
  .update(updates)
  .eq('id', id)
  .select()
  .single()  // ุฃู .maybeSingle()
```

### **ุงูุทุฑููุฉ ุงูุฌุฏูุฏุฉ (ุชุนูู ุฏุงุฆูุงู):**
```typescript
// โ ุงูุญู: ูุตู ุงูุชุญุฏูุซ ุนู ุงูุฌูุจ
// 1. ุชูููุฐ ุงูุชุญุฏูุซ
await supabase
  .from('fabrics')
  .update(cleanUpdates)
  .eq('id', id)

// 2. ุฌูุจ ุงูุจูุงูุงุช ุงููุญุฏุซุฉ
const { data } = await supabase
  .from('fabrics')
  .select('*')
  .eq('id', id)
  .single()
```

---

## ๐งช **ุงูุงุฎุชุจุงุฑ:**

### **ุงูุฎุทูุงุช:**
1. ุงูุชุญ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงูุฃููุดุฉ (`/dashboard/fabrics`)
2. ุงุฎุชุฑ ุฃู ููุงุด ูุงุถุบุท "ุชุนุฏูู"
3. ูู ุจุชุนุฏูู ุฃู ุญูู (ุงูุงุณูุ ุงููุตูุ ุงูุณุนุฑุ ุฅูุฎ)
4. ุงุถุบุท "ุญูุธ"

### **ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- โ ูุชู ุชุญุฏูุซ ุงูููุงุด ุจูุฌุงุญ
- โ ุชุธูุฑ ุฑุณุงูุฉ "ุชู ุชุญุฏูุซ ุงูููุงุด ุจูุฌุงุญ"
- โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู Console
- โ ูุชู ุชุญุฏูุซ ุงูุจูุงูุงุช ูู ุงููุงุฌูุฉ ููุฑุงู

---

## ๐ **ุงููููุงุช ุงููุนุฏูุฉ:**

| ุงูููู | ุงูุชุนุฏูู | ุงูุญุงูุฉ |
|------|---------|--------|
| `src/lib/services/fabric-service.ts` | ุฅุตูุงุญ ุฏุงูุฉ `update()` | โ ููุชูู |

---

## โ **ุงูุญุงูุฉ ุงูููุงุฆูุฉ:**

- โ ุชู ุฅุตูุงุญ ุฎุทุฃ "Cannot coerce the result to a single JSON object"
- โ ุชู ุฅุถุงูุฉ ุชูุธูู ููุจูุงูุงุช ูุจู ุงูุฅุฑุณุงู
- โ ุชู ุฅุถุงูุฉ ูุญุต ุดุงูู ูููุชุงุฆุฌ
- โ ุชู ุชุญุณูู Logging ููุชุชุจุน ุงูุฃูุถู
- โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูู ุงูููุฏ
- โณ ุฌุงูุฒ ููุงุฎุชุจุงุฑ

---

ุชู ุฅุตูุงุญ ุงููุดููุฉ ุจูุฌุงุญ! ๐

