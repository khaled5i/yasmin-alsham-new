# โ ุงูุชูุงู ุชุฑุญูู ุงูููุถูุฉ ูุงูุณูุฉ ุฅูู Supabase

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุจูุฌุงุญ ุฅููุงู ุนูููุฉ ููู ููุฒุงุช ุงูููุถูุฉ (Favorites) ูุงูุณูุฉ (Cart) ูู localStorage ุฅูู ูุงุนุฏุฉ ุจูุงูุงุช Supabase ุงูุฎุงุฑุฌูุฉ. ูุฐุง ุงูุชุฑุญูู ูููุฑ:

- โ **ุฏุนู ุงููุณุชุฎุฏููู ุงููุฌููููู**: ูููู ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู ุฅุถุงูุฉ ุนูุงุตุฑ ููููุถูุฉ ูุงูุณูุฉ
- โ **ุงููุฒุงููุฉ ุจูู ุงูุฃุฌูุฒุฉ**: ุงูุจูุงูุงุช ูุชุงุญุฉ ุนุจุฑ ุฌููุน ุงูุฃุฌูุฒุฉ ูููุณุชุฎุฏููู ุงููุณุฌููู
- โ **ุงูุฃูุงู ุงููุญูู**: ุณูุงุณุงุช RLS ุชุญูู ุงูุจูุงูุงุช
- โ **Fallback Strategy**: ุงุณุชุฎุฏุงู localStorage ููุณุฎุฉ ุงุญุชูุงุทูุฉ
- โ **Optimistic Updates**: ุชุญุฏูุซุงุช ููุฑูุฉ ูููุงุฌูุฉ ูุน ุงูุชุฑุงุฌุน ุงูุชููุงุฆู

---

## ๐ ุงููููุงุช ุงูููุดุฃุฉ/ุงููุญุฏุซุฉ

### 1๏ธโฃ **ุงููุฑุญูุฉ 1: ูุงุนุฏุฉ ุงูุจูุงูุงุช**

#### โ `migrations/06-favorites-cart-migration.sql` (323 ุณุทุฑ)
- ุชุญุฏูุซ ุฌุฏูู `favorites` ูุฅุถุงูุฉ `session_id`
- ุชุญุฏูุซ ุฌุฏูู `cart_items` ูุฅุถุงูุฉ `session_id` ู `last_activity_at`
- ุณูุงุณุงุช RLS ุฌุฏูุฏุฉ ุชุฏุนู ุงููุณุชุฎุฏููู ุงููุฌููููู ูุงููุณุฌููู
- ุฏุงูุฉ `merge_session_to_user()` ูุฏูุฌ ุจูุงูุงุช ุงูุฌูุณุฉ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
- ุฏุงูุฉ `cleanup_old_carts()` ูุชูุธูู ุงูุจูุงูุงุช ุงููุฏููุฉ
- Trigger ูุชุญุฏูุซ `last_activity_at` ุชููุงุฆูุงู

**ุงูุฎุทูุงุช ุงููุทููุจุฉ:**
```bash
# 1. ุงูุชุญ Supabase Dashboard
# 2. ุงูุชูู ุฅูู SQL Editor
# 3. ุงูุณุฎ ูุญุชูู migrations/06-favorites-cart-migration.sql
# 4. ูู ุจุชุดุบูู ุงูู SQL
```

---

### 2๏ธโฃ **ุงููุฑุญูุฉ 2: ุทุจูุฉ ุงูุฎุฏูุงุช**

#### โ `src/lib/services/favorites-cart-service.ts` (716 ุณุทุฑ)
ุฎุฏูุงุช ุดุงููุฉ ููููุถูุฉ ูุงูุณูุฉ:

**Session Management:**
- `getOrCreateSessionId()` - ุฅูุดุงุก/ุงูุญุตูู ุนูู UUID ููุฌูุณุฉ
- `clearSessionId()` - ุญุฐู session_id
- `mergeSessionToUser()` - ุฏูุฌ ุจูุงูุงุช ุงูุฌูุณุฉ ูุน ุงููุณุชุฎุฏู

**FavoritesService:**
- `getAll()` - ุฌูุจ ุฌููุน ุงูููุถูุฉ
- `add(designId)` - ุฅุถุงูุฉ ููููุถูุฉ
- `remove(designId)` - ุญุฐู ูู ุงูููุถูุฉ
- `isFavorite(designId)` - ุงูุชุญูู ูู ูุฌูุฏ ุนูุตุฑ
- `clear()` - ุญุฐู ุฌููุน ุงูููุถูุฉ

**CartService:**
- `getAll()` - ุฌูุจ ุฌููุน ุนูุงุตุฑ ุงูุณูุฉ
- `add({designId, quantity, selectedSize, selectedColor})` - ุฅุถุงูุฉ ููุณูุฉ
- `update(itemId, {quantity})` - ุชุญุฏูุซ ุนูุตุฑ
- `remove(itemId)` - ุญุฐู ุนูุตุฑ
- `clear()` - ุญุฐู ุฌููุน ุงูุนูุงุตุฑ
- `getTotal()` - ุญุณุงุจ ุงูุฅุฌูุงูู

**ุงููููุฒุงุช:**
- ูุนุงูุฌุฉ ุดุงููุฉ ููุฃุฎุทุงุก
- Fallback ุฅูู localStorage ุนูุฏ ูุดู Supabase
- ุฏุนู ูุงูู ูููุณุชุฎุฏููู ุงููุฌููููู ูุงููุณุฌููู

---

### 3๏ธโฃ **ุงููุฑุญูุฉ 3: ุชูุงูู ุงููุงุฌูุฉ ุงูุฃูุงููุฉ**

#### โ `src/store/shopStore.ts` (ูุญุฏุซ)
- ุชุญุฏูุซ ุฌููุน ุฏูุงู ุงูููุถูุฉ ูุงุณุชุฎุฏุงู `FavoritesService`
- ุชุญุฏูุซ ุฌููุน ุฏูุงู ุงูุณูุฉ ูุงุณุชุฎุฏุงู `CartService`
- ุฅุถุงูุฉ `loadFavorites()` ู `loadCart()` ูุชุญููู ุงูุจูุงูุงุช ูู Supabase
- ุชุทุจูู Optimistic Updates ูุน ุงูุชุฑุงุฌุน ุงูุชููุงุฆู
- ุฅุฒุงูุฉ ุญูุธ favorites ู cart ูู persist middleware

#### โ `src/store/authStore.ts` (ูุญุฏุซ)
- ุฅุถุงูุฉ ุงุณุชุฏุนุงุก `mergeSessionToUser()` ุจุนุฏ ุชุณุฌูู ุงูุฏุฎูู
- ุฏูุฌ ุชููุงุฆู ูุจูุงูุงุช ุงูุฌูุณุฉ ูุน ุญุณุงุจ ุงููุณุชุฎุฏู

#### โ `src/app/favorites/page.tsx` (ูุญุฏุซ)
- ุฅุถุงูุฉ `loadFavorites()` ูู useEffect
- ุชุญููู ุงูููุถูุฉ ูู Supabase ุนูุฏ ุชุญููู ุงูุตูุญุฉ

#### โ `src/app/cart/page.tsx` (ูุญุฏุซ)
- ุฅุถุงูุฉ `loadCart()` ูู useEffect
- ุชุญููู ุงูุณูุฉ ูู Supabase ุนูุฏ ุชุญููู ุงูุตูุญุฉ

#### โ `src/app/designs/page.tsx` (ูุญุฏุซ)
- ุฅุถุงูุฉ `loadFavorites()` ู `loadCart()` ูู useEffect
- ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุตูุญุฉ ุงูุชุตุงููู

#### โ `src/components/Header.tsx` (ูุญุฏุซ)
- ุฅุถุงูุฉ `loadFavorites()` ู `loadCart()` ูู useEffect
- ุชุญุฏูุซ ุนุฏุงุฏุงุช ุงูููุถูุฉ ูุงูุณูุฉ ูู Supabase

---

### 4๏ธโฃ **ุงููุฑุญูุฉ 4: ุงูุชุฑุญูู ูุงูุงุฎุชุจุงุฑ**

#### โ `src/lib/migrations/migrate-favorites-cart.ts` (300 ุณุทุฑ)
ุณูุฑูุจุช ุชุฑุญูู ุงูุจูุงูุงุช ูู localStorage ุฅูู Supabase:

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:**
- `migrateFavoritesAndCart(userId)` - ุชุฑุญูู ุฌููุน ุงูุจูุงูุงุช
- `clearLocalStorageAfterMigration()` - ุญุฐู ุงูุจูุงูุงุช ูู localStorage
- `runMigration()` - ุชุดุบูู ุงูุชุฑุญูู ูู Console

**ุงูุงุณุชุฎุฏุงู:**
```javascript
// ูู Console ุงููุชุตูุญ
import { runMigration } from '@/lib/migrations/migrate-favorites-cart'
await runMigration()
```

#### โ `src/lib/migrations/rollback-favorites-cart.ts` (300 ุณุทุฑ)
ุฎุทุฉ ุงูุชุฑุงุฌุน ูู ุญุงูุฉ ูุดู ุงูุชุฑุญูู:

**ุงููุธุงุฆู ุงูุฑุฆูุณูุฉ:**
- `rollbackToLocalStorage(userId)` - ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู Supabase ุฅูู localStorage
- `deleteAllDataFromSupabase(userId)` - ุญุฐู ุฌููุน ุงูุจูุงูุงุช ูู Supabase
- `runRollback()` - ุชุดุบูู ุงูุชุฑุงุฌุน ูู Console

**ุงูุงุณุชุฎุฏุงู:**
```javascript
// ูู Console ุงููุชุตูุญ
import { runRollback } from '@/lib/migrations/rollback-favorites-cart'
await runRollback()
```

---

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชุทุจูู Migration ุนูู Supabase

```bash
# 1. ุงูุชุญ Supabase Dashboard
https://supabase.com/dashboard/project/qbbijtyrikhybgszzbjz

# 2. ุงูุชูู ุฅูู SQL Editor
# 3. ุงูุณุฎ ูุญุชูู migrations/06-favorites-cart-migration.sql
# 4. ูู ุจุชุดุบูู ุงูู SQL
```

### 2. ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ

```bash
npm install uuid
npm install --save-dev @types/uuid
```

โ **ุชู ุจุงููุนู** - ุงูููุชุจุงุช ูุซุจุชุฉ

### 3. ุงุฎุชุจุงุฑ ุงููุธุงุฆู

#### ุงุฎุชุจุงุฑ ุงููุณุชุฎุฏููู ุงููุฌููููู:
1. ุงูุชุญ ุงููุชุตูุญ ูู ูุถุน Incognito
2. ุงูุชูู ุฅูู ุตูุญุฉ ุงูุชุตุงููู
3. ุฃุถู ุนูุงุตุฑ ููููุถูุฉ ูุงูุณูุฉ
4. ุชุญูู ูู ุญูุธ ุงูุจูุงูุงุช ูู Supabase

#### ุงุฎุชุจุงุฑ ุงููุณุชุฎุฏููู ุงููุณุฌููู:
1. ุณุฌู ุฏุฎูู ุจุญุณุงุจ ูุณุชุฎุฏู
2. ุฃุถู ุนูุงุตุฑ ููููุถูุฉ ูุงูุณูุฉ
3. ุณุฌู ุฎุฑูุฌ ุซู ุณุฌู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู
4. ุชุญูู ูู ุจูุงุก ุงูุจูุงูุงุช

#### ุงุฎุชุจุงุฑ ุงูุฏูุฌ:
1. ุงูุชุญ ุงููุชุตูุญ ูู ูุถุน Incognito
2. ุฃุถู ุนูุงุตุฑ ููููุถูุฉ ูุงูุณูุฉ (ููุณุชุฎุฏู ูุฌููู)
3. ุณุฌู ุฏุฎูู ุจุญุณุงุจ ูุณุชุฎุฏู
4. ุชุญูู ูู ุฏูุฌ ุงูุจูุงูุงุช ุชููุงุฆูุงู

### 4. ุชุฑุญูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ (ุงุฎุชูุงุฑู)

ุฅุฐุง ูุงู ูุฏูู ุจูุงูุงุช ูู localStorage:

```javascript
// ูู Console ุงููุชุตูุญ
import { runMigration } from '@/lib/migrations/migrate-favorites-cart'
await runMigration()
```

---

## ๐ ุงูุชุญูู ูู ุงููุฌุงุญ

### โ ูุงุนุฏุฉ ุงูุจูุงูุงุช
- [ ] ุฌุฏูู `favorites` ูุญุชูู ุนูู `session_id`
- [ ] ุฌุฏูู `cart_items` ูุญุชูู ุนูู `session_id` ู `last_activity_at`
- [ ] ุณูุงุณุงุช RLS ุชุณูุญ ูููุณุชุฎุฏููู ุงููุฌููููู ุจุงูุนูููุงุช
- [ ] ุฏุงูุฉ `merge_session_to_user()` ููุฌูุฏุฉ
- [ ] ุฏุงูุฉ `cleanup_old_carts()` ููุฌูุฏุฉ

### โ ุงููุธุงุฆู
- [ ] ุงููุณุชุฎุฏููู ุงููุฌููููู ูููููู ุฅุถุงูุฉ ููููุถูุฉ ูุงูุณูุฉ
- [ ] ุงููุณุชุฎุฏููู ุงููุณุฌููู ูููููู ุฅุถุงูุฉ ููููุถูุฉ ูุงูุณูุฉ
- [ ] ุงูุจูุงูุงุช ุชูุฏูุฌ ุชููุงุฆูุงู ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
- [ ] ุงูุจูุงูุงุช ุชูุญูุธ ุจูู ุงูุฌูุณุงุช
- [ ] Fallback ุฅูู localStorage ูุนูู ุนูุฏ ูุดู Supabase

### โ ุงูุฃุฏุงุก
- [ ] ููุช ุงูุชุญููู < 500ms
- [ ] Optimistic Updates ุชุนูู ุจุณูุงุณุฉ
- [ ] ูุง ููุฌุฏ ุชุฃุฎูุฑ ููุญูุธ ูู ุงููุงุฌูุฉ

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

- **ุฅุฌูุงูู ุงููููุงุช ุงูููุดุฃุฉ**: 3
- **ุฅุฌูุงูู ุงููููุงุช ุงููุญุฏุซุฉ**: 6
- **ุฅุฌูุงูู ุงูุฃุณุทุฑ ุงูููุชูุจุฉ**: ~2,000 ุณุทุฑ
- **ุงูููุช ุงูููุฏุฑ ููุชุทุจูู**: 30 ุฏูููุฉ
- **ุงูููุช ุงูููุฏุฑ ููุงุฎุชุจุงุฑ**: 1 ุณุงุนุฉ

---

## ๐ฏ ุงูุฎุทูุงุช ุงูุชุงููุฉ

1. โ ุชุทุจูู Migration ุนูู Supabase
2. โ ุงุฎุชุจุงุฑ ุฌููุน ุงููุธุงุฆู
3. โ ุชุฑุญูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ (ุฅู ูุฌุฏุช)
4. โ ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุฃุฎุทุงุก
5. โ ุชุญุฏูุซ ุงูุชูุซูู ุฅุฐุง ูุฒู ุงูุฃูุฑ

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูุง ูููู ูููุณุชุฎุฏููู ุงููุฌููููู ุฅุถุงูุฉ ุนูุงุตุฑ

**ุงูุญู:**
- ุชุญูู ูู ุชุทุจูู ุณูุงุณุงุช RLS ุงูุฌุฏูุฏุฉ
- ุชุญูู ูู ูุฌูุฏ `session_id` ูู localStorage
- ุชุญูู ูู Console ููุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุจูุงูุงุช ูุง ุชูุฏูุฌ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู

**ุงูุญู:**
- ุชุญูู ูู ุงุณุชุฏุนุงุก `mergeSessionToUser()` ูู authStore
- ุชุญูู ูู ูุฌูุฏ ุฏุงูุฉ `merge_session_to_user()` ูู Supabase
- ุชุญูู ูู Console ููุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุจูุงูุงุช ูุง ุชูุญูุธ

**ุงูุญู:**
- ุชุญูู ูู ุชูููู Supabase ูู `.env.local`
- ุชุญูู ูู ุณูุงุณุงุช RLS
- ุชุญูู ูู Fallback ุฅูู localStorage

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **session_id** ููุญูุธ ูู localStorage ุจููุชุงุญ `yasmin-session-id`
2. **ุงูุฏูุฌ ุงูุชููุงุฆู** ูุญุฏุซ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู ููุท
3. **ุงูุชูุธูู ุงูุชููุงุฆู** ููุจูุงูุงุช ุงููุฏููุฉ ูุฌุจ ุชุดุบููู ูุฏููุงู ุฃู ุนุจุฑ Cron Job
4. **Fallback** ุฅูู localStorage ูุนูู ุชููุงุฆูุงู ุนูุฏ ูุดู Supabase

---

## ๐ ุงููุชูุฌุฉ

ุชู ุจูุฌุงุญ ุฅููุงู ุชุฑุญูู ุงูููุถูุฉ ูุงูุณูุฉ ุฅูู Supabase ูุน ุฏุนู ูุงูู ูููุณุชุฎุฏููู ุงููุฌููููู ูุงููุณุฌูููุ ูุน ุงุณุชุฑุงุชูุฌูุฉ fallback ูููุฉ ูุฃุฏุงุก ูุญุณูู!

