# ุฏููู ุญู ูุดุงูู RLS (Row Level Security)

## ๐ฏ ูุธุฑุฉ ุนุงูุฉ

ูุฐุง ุงูุฏููู ูุณุงุนุฏู ูู ุญู ูุดููุฉ "ูุง ุชูุฌุฏ ุชุตุงููู ูุชุงุญุฉ ุญุงููุงู" ุนูุฏ ูุชุญ ุตูุญุฉ ุงููุชุฌุฑ (`/designs`) ูู ูุชุตูุญ ุฌุฏูุฏ ุฃู ุฌูุงุฒ ุฌุฏูุฏ.

---

## ๐ ุงููุดููุฉ

**ุงูุฃุนุฑุงุถ:**
- ุตูุญุฉ ุงููุชุฌุฑ (`/designs`) ุชุนุฑุถ ุฑุณุงูุฉ "ูุง ุชูุฌุฏ ุชุตุงููู ูุชุงุญุฉ ุญุงููุงู"
- ุงููุดููุฉ ุชุญุฏุซ ููุท ูู ูุชุตูุญุงุช ุฌุฏูุฏุฉ ุฃู ุฃุฌูุฒุฉ ุฌุฏูุฏุฉ
- ุงููุดููุฉ ุชุญุฏุซ ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู (anonymous users)

**ุงูุณุจุจ ุงูุฌุฐุฑู:**
ุณูุงุณุงุช RLS (Row Level Security) ูู Supabase ุชููุน ุงููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู ูู ูุฑุงุกุฉ ุงูููุชุฌุงุช.

**ุงูุณูุงุณุฉ ุงููุฏููุฉ (ุงููุดููุฉ):**
```sql
CREATE POLICY "Anyone can view available products"
  ON public.products
  FOR SELECT
  USING (
    is_available = true 
    AND published_at IS NOT NULL   -- โ ูุฐุง ูููุน ุนุฑุถ ุงูููุชุฌุงุช ุจุฏูู published_at
    AND published_at <= NOW()
  );
```

**ุงููุดููุฉ:**
- ุงูููุชุฌุงุช ุงูุชู ููุณ ููุง `published_at` ูู ุชุธูุฑ
- ุญุชู ูู ูุงูุช `is_available = true`

---

## โ ุงูุญู

### ุงูุฎุทูุฉ 1: ุชูููุฐ Migration ุงูุฌุฏูุฏ

ูู ุจุชูููุฐ ุงูููู `migrations/07-fix-products-rls-policy.sql` ูู Supabase:

1. ุงูุชุญ **Supabase Dashboard**
2. ุงุฐูุจ ุฅูู **SQL Editor**
3. ุงูุณุฎ ูุญุชูู ุงูููู `migrations/07-fix-products-rls-policy.sql`
4. ุงูุตู ุงููุญุชูู ูู SQL Editor
5. ุงุถุบุท **Run**

**ุงูุณูุงุณุฉ ุงูุฌุฏูุฏุฉ (ุงูุญู):**
```sql
CREATE POLICY "Anyone can view available products"
  ON public.products
  FOR SELECT
  USING (
    is_available = true
    AND (
      published_at IS NULL  -- โ ุงูุณูุงุญ ุจุงูููุชุฌุงุช ุจุฏูู ุชุงุฑูุฎ ูุดุฑ
      OR published_at <= NOW()  -- โ ุฃู ุงูููุชุฌุงุช ุงูููุดูุฑุฉ
    )
  );
```

### ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู ูุฌูุฏ ููุชุฌุงุช

ูู ุจุชูููุฐ ุงูุงุณุชุนูุงู ุงูุชุงูู ูู **SQL Editor**:

```sql
SELECT id, title, is_available, published_at, created_at
FROM public.products
ORDER BY created_at DESC;
```

**ุชุญูู ูู:**
- โ ูุฌูุฏ ููุชุฌุงุช ูู ุงูุฌุฏูู
- โ `is_available = true` ููููุชุฌุงุช
- โ `published_at` ุฅูุง `NULL` ุฃู ุชุงุฑูุฎ ูู ุงููุงุถู

### ุงูุฎุทูุฉ 3: ุชุญุฏูุซ published_at (ุงุฎุชูุงุฑู)

ุฅุฐุง ููุช ุชุฑูุฏ ุชุนููู `published_at` ูุฌููุน ุงูููุชุฌุงุช ุงููุชุงุญุฉ:

```sql
UPDATE public.products 
SET published_at = created_at 
WHERE published_at IS NULL AND is_available = true;
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ูุถุน Incognito (ุจุฏูู ุชุณุฌูู ุฏุฎูู)

1. ุงูุชุญ ูุชุตูุญ ูู ูุถุน **Incognito/Private**
2. ุงุฐูุจ ุฅูู `http://localhost:3000/designs`
3. ุงูุชุญ **Developer Tools** (F12)
4. ุงุฐูุจ ุฅูู ุชุจููุจ **Console**

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
๐ ุชุญููู ุงูููุชุฌุงุช ูู Supabase...
๐ ุงูููุงุชุฑ ุงููุทุจูุฉ: {is_available: true}
๐ ุชูููุฐ ุงูุงุณุชุนูุงู...
โ ุชู ุฌูุจ X ููุชุฌ ุจูุฌุงุญ
๐ ูุนูููุงุช ุงูููุชุฌุงุช:
   - ุฅุฌูุงูู ุงูููุชุฌุงุช: X
   - ุงูููุชุฌุงุช ุงููุชุงุญุฉ: X
   - ุงูููุชุฌุงุช ุงูููุดูุฑุฉ: X
```

**ุฅุฐุง ุธูุฑุช ุฑุณุงูุฉ ุฎุทุฃ:**
```
โ ุฎุทุฃ ูู ุฌูุจ ุงูููุชุฌุงุช: {...}
๐ก ุงูุณุจุจ ุงููุญุชูู: ุณูุงุณุงุช RLS ุชููุน ุงููุตูู ููููุชุฌุงุช
๐ก ุงูุญู: ุชุญูู ูู ุณูุงุณุงุช RLS ูู Supabase Dashboard
```

### ุงุฎุชุจุงุฑ 2: ูุชุตูุญุงุช ูุฎุชููุฉ

ุงุฎุชุจุฑ ุงูุตูุญุฉ ูู:
- โ Chrome (Incognito)
- โ Firefox (Private Window)
- โ Edge (InPrivate)
- โ Safari (Private Browsing)

### ุงุฎุชุจุงุฑ 3: ุฃุฌูุฒุฉ ูุฎุชููุฉ

ุงุฎุชุจุฑ ุงูุตูุญุฉ ูู:
- โ ุฌูุงุฒ ููุจููุชุฑ ุขุฎุฑ
- โ ูุงุชู ูุญููู
- โ ุชุงุจูุช

---

## ๐ง ุงูุชุญูู ูู ุณูุงุณุงุช RLS

### ุนุฑุถ ุฌููุน ุงูุณูุงุณุงุช ุนูู ุฌุฏูู products

```sql
SELECT 
  policyname,
  cmd,
  qual,
  with_check
FROM pg_policies 
WHERE tablename = 'products'
ORDER BY policyname;
```

**ุงูุณูุงุณุงุช ุงููุชููุนุฉ:**
1. โ `Anyone can view available products` - ูููุฑุงุกุฉ (SELECT) ููุฌููุน
2. โ `Admins can view all products` - ูููุฑุงุกุฉ (SELECT) ููู Admin
3. โ `Only admins can insert products` - ููุฅุถุงูุฉ (INSERT) ููู Admin ููุท
4. โ `Only admins can update products` - ููุชุนุฏูู (UPDATE) ููู Admin ููุท
5. โ `Only admins can delete products` - ููุญุฐู (DELETE) ููู Admin ููุท

### ุงูุชุญูู ูู ุงูุตูุงุญูุงุช

```sql
SELECT 
  grantee,
  privilege_type
FROM information_schema.role_table_grants
WHERE table_name = 'products'
ORDER BY grantee, privilege_type;
```

**ุงูุตูุงุญูุงุช ุงููุชููุนุฉ:**
- โ `anon` โ `SELECT` (ูููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู)
- โ `authenticated` โ `SELECT`, `INSERT`, `UPDATE`, `DELETE` (ูููุณุชุฎุฏููู ุงููุณุฌููู)

---

## ๐ ุญู ุงููุดุงูู ุงูุดุงุฆุนุฉ

### ุงููุดููุฉ 1: "ูุง ุชูุฌุฏ ุชุตุงููู ูุชุงุญุฉ ุญุงููุงู"

**ุงูุณุจุจ ุงููุญุชูู:**
- ุณูุงุณุงุช RLS ุชููุน ุงููุตูู
- ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฌููุน ุงูููุชุฌุงุช `is_available = false`

**ุงูุญู:**
1. ููุฐ `migrations/07-fix-products-rls-policy.sql`
2. ุชุญูู ูู ูุฌูุฏ ููุชุฌุงุช ูุน `is_available = true`
3. ุงูุชุญ Console (F12) ูุฑุคูุฉ ุฑุณุงุฆู ุงูุฎุทุฃ ุงูุชูุตูููุฉ

### ุงููุดููุฉ 2: ุฎุทุฃ "PGRST116"

**ุงูุณุจุจ:**
ุณูุงุณุงุช RLS ุชููุน ุงููุตูู ููููุชุฌุงุช

**ุงูุญู:**
```sql
-- ุญุฐู ุงูุณูุงุณุฉ ุงููุฏููุฉ
DROP POLICY IF EXISTS "Anyone can view available products" ON public.products;

-- ุฅูุดุงุก ุงูุณูุงุณุฉ ุงูุฌุฏูุฏุฉ
CREATE POLICY "Anyone can view available products"
  ON public.products
  FOR SELECT
  USING (
    is_available = true
    AND (published_at IS NULL OR published_at <= NOW())
  );
```

### ุงููุดููุฉ 3: ุงูุตูุญุฉ ุชุนูู ูู ูุชุตูุญ ูุงุญุฏ ููุท

**ุงูุณุจุจ:**
Caching ูู localStorage - ุงููุชุตูุญ ุงูุฃูู ูุฏูู cacheุ ุงููุชุตูุญ ุงูุฌุฏูุฏ ููุณ ูุฏูู

**ุงูุญู:**
ูุฐุง ุณููู ุทุจูุนู. ุงููุดููุฉ ุงูุญููููุฉ ูู ุนุฏู ุชุญููู ุงูููุชุฌุงุช ูู Supabase ูู ุงููุชุตูุญ ุงูุฌุฏูุฏ.

### ุงููุดููุฉ 4: "Supabase not configured"

**ุงูุณุจุจ:**
ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุบูุฑ ููููููุฉ

**ุงูุญู:**
1. ุชุญูู ูู ูุฌูุฏ ููู `.env.local`
2. ุชุฃูุฏ ูู ูุฌูุฏ:
   ```
   NEXT_PUBLIC_SUPABASE_URL=your-project-url
   NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
   ```
3. ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู: `npm run dev`

---

## ๐ ูุนูููุงุช ุฅุถุงููุฉ

### ููู RLS (Row Level Security)

**ูุง ูู RLSุ**
- ูุธุงู ุฃูุงู ุนูู ูุณุชูู ุงูุตููู ูู PostgreSQL
- ูุชุญูู ูู ูู ููููู ูุฑุงุกุฉ/ูุชุงุจุฉ/ุชุนุฏูู/ุญุฐู ูู ุตู ูู ุงูุฌุฏูู
- ูุนูู ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ููุณ ุนูู ูุณุชูู ุงูุชุทุจูู)

**ุฃููุงุน ุงููุณุชุฎุฏููู ูู Supabase:**
1. **`anon`** - ุงููุณุชุฎุฏููู ุบูุฑ ุงููุณุฌููู (anonymous)
2. **`authenticated`** - ุงููุณุชุฎุฏููู ุงููุณุฌููู
3. **`service_role`** - ุงูุฎุฏูุงุช (ุชุชุฌุงูุฒ RLS)

**ููู ุชุนูู ุงูุณูุงุณุงุชุ**
```sql
CREATE POLICY "policy_name"
  ON table_name
  FOR operation  -- SELECT, INSERT, UPDATE, DELETE, ALL
  TO role        -- anon, authenticated, public
  USING (condition)  -- ุดุฑุท ุงููุฑุงุกุฉ
  WITH CHECK (condition);  -- ุดุฑุท ุงููุชุงุจุฉ
```

### ุฃูุถู ุงูููุงุฑุณุงุช

1. โ **ุงุฎุชุจุฑ ุฏุงุฆูุงู ูู ูุถุน Incognito**
   - ูุชุฌูุจ ุชุฃุซูุฑ ุงูู cache
   - ููุญุงูุงุฉ ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ

2. โ **ุงุณุชุฎุฏู Console ููุชุดุฎูุต**
   - ุงูุชุญ Developer Tools (F12)
   - ุฑุงูุจ ุฑุณุงุฆู ุงูุฎุทุฃ
   - ุชุญูู ูู Network tab

3. โ **ุงุฎุชุจุฑ ุงูุณูุงุณุงุช ูู SQL Editor**
   ```sql
   -- ุงุฎุชุจุงุฑ ููุณุชุฎุฏู ุบูุฑ ูุณุฌู
   SET ROLE anon;
   SELECT * FROM products WHERE is_available = true;
   RESET ROLE;
   ```

4. โ **ูุซูู ุงูุชุบููุฑุงุช**
   - ุงุญุชูุธ ุจูููุงุช Migration
   - ุงูุชุจ ุชุนูููุงุช ูุงุถุญุฉ
   - ุณุฌูู ุงูุฃุณุจุงุจ ูุงูุญููู

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

### 1. `migrations/07-fix-products-rls-policy.sql` โ **ุฌุฏูุฏ**
- ุฅุตูุงุญ ุณูุงุณุฉ RLS ููููุชุฌุงุช
- ุงูุณูุงุญ ุจุนุฑุถ ุงูููุชุฌุงุช ุจุฏูู `published_at`

### 2. `src/app/designs/page.tsx` โ **ูุญุฏุซ**
- ุฅุถุงูุฉ ูุนุงูุฌุฉ ุฃูุถู ููุฃุฎุทุงุก
- ุนุฑุถ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- ุฒุฑ "ุฅุนุงุฏุฉ ุงููุญุงููุฉ"
- Logging ูุญุณูู

### 3. `src/lib/services/store-service.ts` โ **ูุญุฏุซ**
- Logging ุชูุตููู
- ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- ูุนูููุงุช ุชุดุฎูุตูุฉ

---

## ๐ ุงูุฎูุงุตุฉ

**ุชู ุจูุฌุงุญ:**
- โ ุชุญุฏูุฏ ุงููุดููุฉ: ุณูุงุณุงุช RLS ุชููุน ุนุฑุถ ุงูููุชุฌุงุช
- โ ุฅูุดุงุก Migration ูุฅุตูุงุญ ุงูุณูุงุณุฉ
- โ ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูู ุงูุตูุญุฉ
- โ ุฅุถุงูุฉ Logging ุชูุตููู
- โ ุชูุซูู ุดุงูู ูููุดููุฉ ูุงูุญู

**ุงูุฎุทูุงุช ุงูุชุงููุฉ:**
1. ููุฐ `migrations/07-fix-products-rls-policy.sql` ูู Supabase
2. ุงุฎุชุจุฑ ุงูุตูุญุฉ ูู ูุถุน Incognito
3. ุชุญูู ูู Console ููุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก
4. ุงุฎุชุจุฑ ูู ูุชุตูุญุงุช ูุฃุฌูุฒุฉ ูุฎุชููุฉ

**ุฃุฎุจุฑูู ุจุงููุชูุฌุฉ!** ๐

