# ุชุทุจูู RLS Policy ููุฏูุฑ ุงููุฑุดุฉ - ุงูุทูุจุงุช
# Apply Workshop Manager Orders RLS Policy

## ๐ฏ ุงููุฏู

ุฅุถุงูุฉ ุตูุงุญูุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช (RLS Policies) ููุฏูุฑ ุงููุฑุดุฉ ูุชููููู ูู:
- โ ุฑุคูุฉ ุฌููุน ุงูุทูุจุงุช (SELECT)
- โ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจุงุช (UPDATE) - ูุซู ุชุณููู ุงูุทูุจุงุช ุงูููุชููุฉ

---

## ๐ ุฎุทูุงุช ุณุฑูุนุฉ

### ุงูุฎุทูุฉ 1: ุงูุชุญ Supabase Dashboard
1. ุงุฐูุจ ุฅูู: https://supabase.com/dashboard
2. ุงุฎุชุฑ ูุดุฑูุนู
3. ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉุ ุงุฎุชุฑ **SQL Editor**

---

### ุงูุฎุทูุฉ 2: ููุฐ ุงูููุฏ ุงูุชุงูู

ุงูุณุฎ ูุงูุตู ุงูููุฏ ุงูุชุงูู ูู SQL Editor ูุงุถุบุท **Run**:

```sql
-- ============================================================================
-- ุฅุถุงูุฉ RLS Policy ููุฏูุฑ ุงููุฑุดุฉ ูุฑุคูุฉ ุฌููุน ุงูุทูุจุงุช
-- ============================================================================

-- ุงูุฎุทูุฉ 1: ุฅุถุงูุฉ ุณูุงุณุฉ SELECT ููุฏูุฑ ุงููุฑุดุฉ
DROP POLICY IF EXISTS "Workshop managers can view all orders" ON orders;
CREATE POLICY "Workshop managers can view all orders"
ON orders FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM workers
    WHERE workers.user_id = auth.uid()
    AND workers.worker_type = 'workshop_manager'
  )
);

-- ุงูุฎุทูุฉ 2: ุฅุถุงูุฉ ุณูุงุณุฉ UPDATE ููุฏูุฑ ุงููุฑุดุฉ
DROP POLICY IF EXISTS "Workshop managers can update orders" ON orders;
CREATE POLICY "Workshop managers can update orders"
ON orders FOR UPDATE
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM workers
    WHERE workers.user_id = auth.uid()
    AND workers.worker_type = 'workshop_manager'
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM workers
    WHERE workers.user_id = auth.uid()
    AND workers.worker_type = 'workshop_manager'
  )
);

-- ุงูุชุญูู ูู ูุฌุงุญ ุงูุนูููุฉ
SELECT 
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd
FROM pg_policies
WHERE tablename = 'orders'
AND policyname LIKE '%workshop%'
ORDER BY policyname;
```

---

### ุงูุฎุทูุฉ 3: ุชุญูู ูู ุงููุชูุฌุฉ

ูุฌุจ ุฃู ุชุฑู ุณูุงุณุชูู ุฌุฏูุฏุชูู:
- โ `Workshop managers can view all orders` (SELECT)
- โ `Workshop managers can update orders` (UPDATE)

---

## โ ุงูุชุญูู ูู ูุฌุงุญ ุงูุชุทุจูู

### ุงุฎุชุจุงุฑ 1: ุงูุชุญูู ูู ุงูุณูุงุณุงุช
```sql
SELECT 
  policyname,
  cmd,
  qual
FROM pg_policies
WHERE tablename = 'orders'
ORDER BY policyname;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ูุฌุจ ุฃู ุชุฑู ุฌููุน ุงูุณูุงุณุงุช ุจูุง ูููุง:
- `Admins can view all orders`
- `Workers can view assigned orders`
- `Clients can view their orders`
- **`Workshop managers can view all orders`** โ ุฌุฏูุฏ
- **`Workshop managers can update orders`** โ ุฌุฏูุฏ

---

### ุงุฎุชุจุงุฑ 2: ุชุณุฌูู ุงูุฏุฎูู ููุฏูุฑ ูุฑุดุฉ
1. ุณุฌู ุงูุฏุฎูู ุจุญุณุงุจ ูุฏูุฑ ูุฑุดุฉ
2. ุงุฐูุจ ุฅูู `/dashboard/workshop-manager`
3. ุงูุชุญ ุตูุญุฉ ุงูุทูุจุงุช ุงูุญุฏูุซุฉ
4. **ูุฌุจ ุฃู ุชุฑู ุฌููุน ุงูุทูุจุงุช** โ

---

### ุงุฎุชุจุงุฑ 3: ุงุฎุชุจุงุฑ ุงูุชุญุฏูุซ
1. ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูุทูุจุงุช ุงูููุชููุฉ
2. ุญุงูู ุชุณููู ุทูุจ
3. **ูุฌุจ ุฃู ุชูุฌุญ ุงูุนูููุฉ** โ

---

## ๐ ุงูุตูุงุญูุงุช ุงููุงููุฉ ููุฏูุฑ ุงููุฑุดุฉ

| ุงูุนูููุฉ | ุงูุตูุงุญูุฉ | ุงููุตู |
|---------|----------|-------|
| **SELECT** | โ ูุชุงุญ | ุฑุคูุฉ ุฌููุน ุงูุทูุจุงุช |
| **UPDATE** | โ ูุชุงุญ | ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจุงุช (ุชุณููู) |
| **INSERT** | โ ุบูุฑ ูุชุงุญ | ุฅูุดุงุก ุทูุจุงุช ุฌุฏูุฏุฉ (ูููุฏูุฑ ููุท) |
| **DELETE** | โ ุบูุฑ ูุชุงุญ | ุญุฐู ุงูุทูุจุงุช (ูููุฏูุฑ ููุท) |

---

## ๐ ููุงุฑูุฉ ุงูุตูุงุญูุงุช

| ููุน ุงููุณุชุฎุฏู | SELECT | UPDATE | INSERT | DELETE |
|--------------|--------|--------|--------|--------|
| **Admin** | โ ุฌููุน ุงูุทูุจุงุช | โ | โ | โ |
| **Workshop Manager** | โ ุฌููุน ุงูุทูุจุงุช | โ | โ | โ |
| **Tailor** | โ ุทูุจุงุชู ููุท | โ ุทูุจุงุชู ููุท | โ | โ |
| **Client** | โ ุทูุจุงุชู ููุท | โ | โ | โ |

---

## ๐ ุญู ุงููุดุงูู

### ุงููุดููุฉ: ูุง ุชุฒุงู ุงูุทูุจุงุช ูุง ุชุธูุฑ
**ุงูุญู:**
1. ุชุฃูุฏ ูู ุชุทุจูู Migration ุงูุฃูู (`10-add-workshop-manager-type.sql`)
2. ุชุฃูุฏ ูู ุฃู `worker_type` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู `'workshop_manager'`
3. ุชุญูู ูู ุงูุณูุงุณุงุช:
```sql
SELECT * FROM pg_policies WHERE tablename = 'orders';
```

### ุงููุดููุฉ: "permission denied for table orders"
**ุงูุญู:**
- ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู ุจุญุณุงุจ ูุฏูุฑ ูุฑุดุฉ ุตุญูุญ
- ุชุญูู ูู ุฃู RLS ููุนู ุนูู ุฌุฏูู orders:
```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE tablename = 'orders';
```

### ุงููุดููุฉ: ูููู ุฑุคูุฉ ุงูุทูุจุงุช ููู ูุง ูููู ุชุญุฏูุซูุง
**ุงูุญู:**
- ุชุฃูุฏ ูู ุชุทุจูู ุณูุงุณุฉ UPDATE
- ุชุญูู ูู ุงูุณูุงุณุงุช:
```sql
SELECT policyname, cmd 
FROM pg_policies 
WHERE tablename = 'orders' 
AND policyname LIKE '%workshop%';
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ูุฌุจ ุชุทุจูู Migration ุงูุณุงุจู ุฃููุงู:**
   - ุชุฃูุฏ ูู ุชุทุจูู `10-add-workshop-manager-type.sql` ูุจู ูุฐุง ุงูููู
   - ูุฐุง ุงูููู ูุนุชูุฏ ุนูู ูุฌูุฏ `worker_type = 'workshop_manager'`

2. **ุงูุตูุงุญูุงุช ูุญุฏูุฏุฉ:**
   - ูุฏูุฑ ุงููุฑุดุฉ ูุง ููููู ุฅูุดุงุก ุฃู ุญุฐู ุงูุทูุจุงุช
   - ููููู ููุท ุฑุคูุฉ ูุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจุงุช

3. **ุงูุฃูุงู:**
   - ุงูุณูุงุณุงุช ุชุชุญูู ูู `worker_type` ูู ุฌุฏูู `workers`
   - ูุง ูููู ูุฃู ูุณุชุฎุฏู ุชุฌุงูุฒ ูุฐู ุงูุตูุงุญูุงุช

---

## ๐ ุชู ุจูุฌุงุญ!

ุงูุขู ูุฏูุฑ ุงููุฑุดุฉ ููููู:
1. โ ุฑุคูุฉ ุฌููุน ุงูุทูุจุงุช ูู ุงูุตูุญุงุช ุงูุซูุงุซ
2. โ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจุงุช (ุชุณููู ุงูุทูุจุงุช ุงูููุชููุฉ)
3. โ ูุชุงุจุนุฉ ุณูุฑ ุงูุนูู ูู ุงููุฑุดุฉ

---

**ุชุงุฑูุฎ ุงูุฅูุดุงุก:** 2024-12-26  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชุทุจูู

